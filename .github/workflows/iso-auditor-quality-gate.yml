name: ISO Auditor Quality Gate

on:
  workflow_dispatch:
    inputs:
      run_benchmark:
        description: "Run benchmark gate (requires reachable ORCH URL)"
        type: boolean
        default: false
      orch_base_url:
        description: "ORCH base URL"
        required: false
        default: ""
      tenant_id:
        description: "Benchmark tenant id"
        required: false
        default: ""
      collection_id:
        description: "Benchmark collection id"
        required: false
        default: ""

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: orch
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run orchestrator unit tests
        run: |
          PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 python -m pytest -q \
            tests/unit/test_iso_flow_graph.py \
            tests/unit/test_qa_orchestrator_use_case.py \
            tests/unit/test_citation_details.py \
            tests/unit/test_orch_discovery_client.py \
            -p pytest_asyncio.plugin

  benchmark-gate:
    if: ${{ inputs.run_benchmark }}
    runs-on: ubuntu-latest
    needs: unit-tests
    defaults:
      run:
        working-directory: orch
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run benchmark with thresholds
        env:
          AUTH_BEARER_TOKEN: ${{ secrets.AUTH_BEARER_TOKEN }}
        run: |
          if [ -z "${{ inputs.orch_base_url }}" ] || [ -z "${{ inputs.tenant_id }}" ]; then
            echo "Missing orch_base_url or tenant_id"
            exit 2
          fi
          python tests/evaluation/run_iso_auditor_benchmark.py \
            --dataset tests/evaluation/iso_auditor_smoke.json \
            --base-url "${{ inputs.orch_base_url }}" \
            --tenant-id "${{ inputs.tenant_id }}" \
            --collection-id "${{ inputs.collection_id }}" \
            --access-token "${AUTH_BEARER_TOKEN}" \
            --variant-label "ci-gate" \
            --fail-on-thresholds
      - name: Generate dashboard and alert check
        run: |
          python tests/evaluation/generate_iso_auditor_dashboard.py --reports-dir tests/evaluation/reports --out tests/evaluation/reports/iso_auditor_dashboard.md --limit 12
          python tests/evaluation/check_iso_auditor_alerts.py --reports-dir tests/evaluation/reports
      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iso-auditor-benchmark-reports
          path: orch/tests/evaluation/reports/
